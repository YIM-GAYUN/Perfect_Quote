---
alwaysApply: true
description: "Local embedding models usage guidelines for quote generator"
---

# 로컬 임베딩 모델 사용 규칙

## 🎯 핵심 규칙

- **무조건 로컬에 저장된 `/models/sentence-transformers/` 임베딩 모델을 사용해야 한다**
- 온라인 다운로드는 절대 금지한다
- 모델 로딩 실패 시에만 fallback 전략을 사용한다

## 📂 모델 경로 및 설정

- 기본 모델 경로: `./models/sentence-transformers/paraphrase-multilingual-mpnet-base-v2/`
- SentenceTransformer 초기화 시 반드시 `cache_folder` 파라미터 사용
- 예시: `SentenceTransformer('paraphrase-multilingual-mpnet-base-v2', cache_folder='./models/sentence-transformers')`

## ⚡ LangGraph 기반 성능 최적화 규칙

- utils.quote_retriever의 find_similar_quote_cosine_silent() 함수 사용
- 출력 억제 (StringIO) 방식으로 silent 검색 수행
- 임베딩 시스템 로딩 실패 시 fallback_quotes 자동 사용
- 10턴 분석 완료 후에만 명언 검색 시스템 활성화

## 🔍 검증 및 에러 처리

- 서버 시작 시 로컬 모델 존재 여부 검증
- 모델 로딩 실패 시 명확한 에러 메시지 출력
- FAISS 인덱스와 데이터셋 파일 존재 여부 확인
- utils.quote_retriever 모듈 import 실패 시 QUOTE_RETRIEVER_AVAILABLE=False 설정

## 🚫 금지 사항

- Hugging Face Hub에서 자동 다운로드 금지
- 임베딩 시스템 완전 비활성화 금지
- 모델 경로 하드코딩 (상대 경로 사용)
- 백그라운드 임베딩 초기화 사용 금지 (LangGraph에서는 on-demand 로딩)

## 📝 관련 파일

- 메인 서버: [app.py](mdc:app.py)
- 모델 다운로드: [download_models.py](mdc:download_models.py)
- 명언 검색 시스템: [utils/quote_retriever.py](mdc:utils/quote_retriever.py)
- 대화 분석 프롬프트: [utils/analysis_prompt.py](mdc:utils/analysis_prompt.py)
