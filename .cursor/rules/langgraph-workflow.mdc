---
globs: "*.py"
description: "LangGraph workflow and 10-turn analysis system guidelines"
---

# LangGraph ì›Œí¬í”Œë¡œìš° ë° 10í„´ ë¶„ì„ ì‹œìŠ¤í…œ ê·œì¹™

## ğŸ”„ StateGraph ì›Œí¬í”Œë¡œìš° ì›ì¹™

### **ë…¸ë“œ ì—°ê²° ìˆœì„œ**
```
START â†’ validate_user_input â†’ chatbot â†’ save_history â†’ [ì¡°ê±´ë¶€ ë¶„ê¸°]
â”œâ”€ (< 10í„´) â†’ END
â””â”€ (â‰¥ 10í„´) â†’ analyze_chat_history â†’ generate_advice â†’ END
```

### **ìƒíƒœ ê´€ë¦¬ ê·œì¹™**
- ChatbotState TypedDict ì‚¬ìš©ìœ¼ë¡œ íƒ€ì… ì•ˆì „ì„± ë³´ì¥
- ê° ë…¸ë“œëŠ” ê¸°ì¡´ ìƒíƒœë¥¼ ìœ ì§€í•˜ë©° í•„ìš”í•œ í•„ë“œë§Œ ì—…ë°ì´íŠ¸
- `{**state, "new_field": value}` íŒ¨í„´ ì‚¬ìš©

## ğŸ¯ 10í„´ ë¶„ì„ ì‹œìŠ¤í…œ

### **ë¶„ì„ íŠ¸ë¦¬ê±° ì¡°ê±´**
- `len(state["chat_history"].messages) >= 10` ì²´í¬
- should_analyze_chat_history() ë¶„ê¸° í•¨ìˆ˜ì—ì„œ ê²°ì •
- ì •í™•íˆ 10í„´ ë‹¬ì„± ì‹œì—ë§Œ ë¶„ì„ ì‹¤í–‰ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)

### **ë¶„ì„ í”„ë¡œì„¸ìŠ¤**
1. **analyze_chat_history()**: ANALYSIS_PROMPTë¡œ ëŒ€í™” íˆìŠ¤í† ë¦¬ ë¶„ì„
2. **generate_advice()**: ì¡°ì–¸, í‚¤ì›Œë“œ, ëª…ì–¸ í›„ë³´ 3ê°œ ìƒì„±
3. **present_quote()**: ì²« ë²ˆì§¸ ëª…ì–¸ í›„ë³´ ì œì‹œ
4. **ëª…ì–¸ ì„ íƒ ëª¨ë“œ ì‹œì‘**: quote_selection_mode = True

## ğŸ’¬ ëª…ì–¸ ì„ íƒ ì¸í„°í˜ì´ìŠ¤

### **ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬**
```python
# í—ˆìš©ë˜ëŠ” ê¸ì • ì‘ë‹µ
['ì˜ˆ', 'yes', 'y', 'ë„¤', 'ì„ íƒ']

# í—ˆìš©ë˜ëŠ” ë¶€ì • ì‘ë‹µ (ë‹¤ìŒ ëª…ì–¸)
['ì•„ë‹ˆì˜¤', 'no', 'n', 'ì•„ë‹ˆ', 'ë‹¤ìŒ']

# ì˜ëª»ëœ ì…ë ¥ ì‹œ ì¬ìš”ì²­
```

### **ëª…ì–¸ ìˆœí™˜ ì‹œìŠ¤í…œ**
- 3ê°œ í›„ë³´ ëª…ì–¸ì„ ìˆœí™˜í•˜ì—¬ ì œì‹œ
- `next_index = (current_index + 1) % len(candidate_quotes)`
- ì‚¬ìš©ìê°€ ì„ íƒí•  ë•Œê¹Œì§€ ë¬´í•œ ìˆœí™˜

## ğŸ”§ Enhanced Solar Chatbot í´ë˜ìŠ¤

### **ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬**
- ì„¸ì…˜ë³„ ë…ë¦½ì ì¸ EnhancedSolarChatbot ì¸ìŠ¤í„´ìŠ¤
- chatbot_sessions ë”•ì…”ë„ˆë¦¬ë¡œ ì„¸ì…˜ ì¶”ì 
- session_lockìœ¼ë¡œ ë™ì‹œì„± ì œì–´

### **ëª¨ë“œ ì „í™˜ ë¡œì§**
```python
# ì¼ë°˜ ëŒ€í™” ëª¨ë“œ
if not quote_selection_mode:
    result = graph.invoke(state)

# ëª…ì–¸ ì„ íƒ ëª¨ë“œ  
if quote_selection_mode:
    process_quote_selection(state)
```

## ğŸ“Š API ì‘ë‹µ êµ¬ì¡°

### **ê¸°ë³¸ ì‘ë‹µ í•„ë“œ**
- content: ì±—ë´‡ ì‘ë‹µ ë©”ì‹œì§€
- conversation_summary: ëŒ€í™” ìš”ì•½ ì •ë³´
- model: "Solar Pro + LangGraph"
- embedding_system: "Enhanced FAISS"

### **10í„´ ë¶„ì„ ì™„ë£Œ ì‹œ ì¶”ê°€ í•„ë“œ**
- analysis_complete: true
- advice: LLM ìƒì„± ì¡°ì–¸
- keywords: ì¶”ì¶œëœ í‚¤ì›Œë“œ ë°°ì—´

### **ëª…ì–¸ ì„ íƒ ì™„ë£Œ ì‹œ ì¶”ê°€ í•„ë“œ**
- quote: ìµœì¢… ì„ íƒëœ ëª…ì–¸ ì •ë³´
- method: "langgraph_enhanced_selection"

## ğŸš« ê¸ˆì§€ ì‚¬í•­

- LangGraph ì›Œí¬í”Œë¡œìš° ì¤‘ê°„ì— ì„ì˜ë¡œ ìƒíƒœ ìˆ˜ì •í•˜ì§€ ë§ ê²ƒ
- 10í„´ ë¯¸ë§Œì—ì„œ ê°•ì œë¡œ ë¶„ì„ ì‹œìŠ¤í…œ ì‹¤í–‰í•˜ì§€ ë§ ê²ƒ
- ëª…ì–¸ ì„ íƒ ëª¨ë“œì—ì„œ ì¼ë°˜ ëŒ€í™” ë…¸ë“œ ì‹¤í–‰í•˜ì§€ ë§ ê²ƒ
- ì„¸ì…˜ ê°„ ìƒíƒœ ê³µìœ  ì ˆëŒ€ ê¸ˆì§€

## ğŸ“ ê´€ë ¨ íŒŒì¼

- ë©”ì¸ ì›Œí¬í”Œë¡œìš°: [app.py](mdc:app.py) - ChatbotState, StateGraph ì •ì˜
- ë¶„ì„ í”„ë¡¬í”„íŠ¸: [utils/analysis_prompt.py](mdc:utils/analysis_prompt.py)
- ëª…ì–¸ ê²€ìƒ‰: [utils/quote_retriever.py](mdc:utils/quote_retriever.py)
- ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸: [utils/system_prompt.py](mdc:utils/system_prompt.py)
